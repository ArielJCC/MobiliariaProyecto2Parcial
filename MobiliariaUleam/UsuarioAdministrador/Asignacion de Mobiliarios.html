<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Uleam - Asignación de Mobiliarios</title>
    <link rel="icon" href="../Imagenes/icon/Mobiliaria-Uleam_transparent.ico" />
    <script
      src="https://kit.fontawesome.com/eb496ab1a0.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  </head>
  <body>
    <div id="app">
      <!-- Área del encabezado -->
      <header class="header-area">
        <div class="top-header">
          <div class="container h-100">
            <div class="row h-100">
              <div class="col-12 h-100">
                <div
                  class="header-content h-100 d-flex align-items-center justify-content-between"
                >
                  <a href="Home.html" class="logo-link">
                    <img
                      src="../Imagenes/Mobiliaria-Uleam.png"
                      alt="Logo"
                      class="logo-img"
                    />
                  </a>
                  <!-- Cerrar sesión -->
                  <div class="login-content">
                    <a href="perfil_administrador.html">Perfil &nbsp; </a>
                    <a
                      href="javascript:void(0);"
                      onclick="confirmarCerrarSesion()"
                      >Cerrar Sesión</a
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Barra de navegación -->
        <div class="academy-main-menu">
          <div class="classy-nav-container breakpoint-off">
            <div class="container">
              <!-- Menú -->
              <nav
                class="classy-navbar justify-content-between"
                id="academyNav"
              >
                <div class="classy-menu">
                  <div class="classynav">
                    <ul>
                      <li><a href="Home.html">Inicio</a></li>
                      <li><a href="inventario.html">Inventario</a></li>
                      <li>
                        <a href="Asignacion de Mobiliarios.html"
                          >Asignación de Mobiliarios</a
                        >
                      </li>
                      <li>
                        <a href="gestion_mobiliario.html"
                          >Gestión de Mobiliario</a
                        >
                      </li>
                      <li>
                        <a href="https://wa.link/cj230k" target="_blank"
                          >Contáctanos</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </nav>
            </div>
          </div>
        </div>
      </header>

      <!-- Texto Superior -->
      <div class="breadcumb-area">
        <div class="bradcumbContent">
          <h2>Asignación de Mobiliarios</h2>
          <h1>Selección del Solicitante</h1>
        </div>
      </div>

      <!-- Sección de Asignación de Mobiliarios -->
      <div class="contact-area mt-50 section-padding-100-70">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
              <div
                class="contact-form-area wow fadeInUp"
                data-wow-delay="300ms"
              >
                <form action="#" method="post" id="formularioAsignacion">
                  <div class="form-group">
                    <label for="nombreSolicitante"
                      >Nombre del Solicitante</label
                    >
                    <input
                      type="text"
                      v-model="nombreSolicitante"
                      @input="buscarUsuario"
                      class="form-control"
                      id="nombreSolicitante"
                      placeholder="Escribe el nombre completo del solicitante"
                    />
                  </div>
                  <div class="form-group">
                    <label for="numeroCedula">Número de Cédula</label>
                    <input
                      type="text"
                      v-model="selectedUsuario.numeroCedula"
                      class="form-control"
                      id="numeroCedula"
                      readonly
                    />
                  </div>
                  <div class="form-group">
                    <label for="entidadFacultad">Entidad o Facultad</label>
                    <input
                      type="text"
                      v-model="selectedUsuario.facultad"
                      class="form-control"
                      id="entidadFacultad"
                      readonly
                    />
                  </div>
                  <div class="form-group">
                    <label for="carreraUsuario">Carrera</label>
                    <input
                      type="text"
                      v-model="selectedUsuario.carrera"
                      class="form-control"
                      id="carreraUsuario"
                      readonly
                    />
                  </div>
                  <div class="form-group">
                    <label for="mobiliarioAsignar">Mobiliario a Asignar</label>
                    <select
                      v-model="selectedMobiliario"
                      class="form-control"
                      id="mobiliarioAsignar"
                    >
                      <option disabled value="">
                        Selecciona un mobiliario
                      </option>
                      <option
                        v-for="mobiliario in mobiliariosDisponibles.filter(mobiliario => !mobiliario.asignado)"
                        :value="mobiliario"
                      >
                        {{ mobiliario.deviceType }} - Código: {{
                        mobiliario.codigoIdentificacion }} - Material: {{
                        mobiliario.material }}
                      </option>
                    </select>
                  </div>
                  <div class="form-group text-center">
                    <button
                      type="button"
                      @click="asignarMobiliario"
                      class="btn academy-btn mt-30"
                      :disabled="!selectedUsuario.nombreCompleto || !selectedMobiliario.deviceType"
                    >
                      Asignar Mobiliario
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Área del pie de página -->
    <footer class="pie-pagina">
      <div class="grupo-1">
        <div class="box">
          <a href="Home.html" class="logo-link">
            <img
              src="../Imagenes/Mobiliaria-Uleam.png"
              alt="Logo"
              class="logo-img"
            />
          </a>
        </div>
        <div class="box">
          <h2>MISIÓN</h2>
          <p>
            En la Uleam, nos comprometemos con una gestión eficiente y
            responsable del inventario de mobiliario.
          </p>
        </div>
        <div class="box">
          <h2>SÍGUENOS</h2>
          <div class="red-social">
            <a href="https://www.facebook.com/" class="fa fa-facebook"></a>
            <a href="https://www.instagram.com/" class="fa fa-instagram"></a>
          </div>
        </div>
      </div>
      <div class="grupo-2">
        <small
          >&copy; 2024 Uleam - Gestión de Inventario de Mobiliario - Todos los
          derechos reservados</small
        >
      </div>
    </footer>
    <!-- Fin del área del pie de página -->

    <script>
      const app = new Vue({
        el: "#app",
        data: {
          usuariosRegistrados: [],
          mobiliariosDisponibles: [],
          selectedUsuario: {},
          selectedMobiliario: {},
          nombreSolicitante: "",
        },
        mounted() {
          this.cargarUsuariosRegistrados();
          this.cargarMobiliariosDisponibles();
        },
        methods: {
          cargarUsuariosRegistrados() {
            const registros =
              JSON.parse(localStorage.getItem("registroUsuariosCliente")) || [];
            this.usuariosRegistrados = registros;
          },
          cargarMobiliariosDisponibles() {
            const mobiliarios =
              JSON.parse(localStorage.getItem("registrosMobiliario")) || [];
            // Agregar propiedad 'asignado' si no existe
            mobiliarios.forEach((mobiliario) => {
              if (!mobiliario.hasOwnProperty("asignado")) {
                mobiliario.asignado = false;
              }
            });
            this.mobiliariosDisponibles = mobiliarios;
          },
          buscarUsuario() {
            if (!this.nombreSolicitante) {
              this.selectedUsuario = {};
              return;
            }
            const encontrado = this.usuariosRegistrados.find((usuario) =>
              usuario.nombreCompleto
                .toLowerCase()
                .includes(this.nombreSolicitante.toLowerCase())
            );
            this.selectedUsuario = encontrado || {};
          },
          asignarMobiliario() {
            if (
              !this.selectedUsuario.nombreCompleto ||
              !this.selectedMobiliario.deviceType
            ) {
              alert("Por favor selecciona un solicitante y un mobiliario.");
              return;
            }

            // Asegurarse de que mobiliariosAsignados esté definido
            if (!Array.isArray(this.selectedUsuario.mobiliariosAsignados)) {
              this.$set(this.selectedUsuario, "mobiliariosAsignados", []);
            }

            // Verificar si el mobiliario ya está asignado al usuario
            const mobiliarioYaAsignado =
              this.selectedUsuario.mobiliariosAsignados.some((mobiliario) => {
                return (
                  mobiliario.deviceType === this.selectedMobiliario.deviceType
                );
              });

            if (mobiliarioYaAsignado) {
              alert("El mobiliario ya está asignado a este usuario.");
              return;
            }

            // Agregar el mobiliario asignado al usuario seleccionado
            const mobiliarioAsignado = {
              deviceType: this.selectedMobiliario.deviceType,
              material: this.selectedMobiliario.material,
              alto: this.selectedMobiliario.alto,
              ancho: this.selectedMobiliario.ancho,
              color: this.selectedMobiliario.color,
              codigoIdentificacion:
                this.selectedMobiliario.codigoIdentificacion,
              message: this.selectedMobiliario.message,
            };
            this.selectedUsuario.mobiliariosAsignados.push(mobiliarioAsignado);

            // Marcar el mobiliario como asignado
            this.selectedMobiliario.asignado = true;

            const index = this.usuariosRegistrados.findIndex(
              (usuario) =>
                usuario.nombreCompleto === this.selectedUsuario.nombreCompleto
            );
            if (index !== -1) {
              this.$set(this.usuariosRegistrados, index, this.selectedUsuario);
              localStorage.setItem(
                "registroUsuariosCliente",
                JSON.stringify(this.usuariosRegistrados)
              );

              // Actualizar la lista de mobiliarios en localStorage
              const mobiliarioIndex = this.mobiliariosDisponibles.findIndex(
                (mobiliario) =>
                  mobiliario.codigoIdentificacion ===
                  this.selectedMobiliario.codigoIdentificacion
              );
              if (mobiliarioIndex !== -1) {
                this.$set(
                  this.mobiliariosDisponibles,
                  mobiliarioIndex,
                  this.selectedMobiliario
                );
                localStorage.setItem(
                  "registrosMobiliario",
                  JSON.stringify(this.mobiliariosDisponibles)
                );
              }

              alert("Mobiliario asignado correctamente.");
              this.limpiarFormulario();
            } else {
              alert("Error al asignar mobiliario. Inténtalo de nuevo.");
            }
          },
          limpiarFormulario() {
            this.selectedUsuario = {};
            this.selectedMobiliario = {};
            this.nombreSolicitante = "";
          },
        },
      });
      // Función para confirmar el cierre de sesión
      function confirmarCerrarSesion() {
        // Mostrar el mensaje de confirmación
        var confirmacion = confirm(
          "¿Estás seguro de que deseas cerrar la sesión?"
        );
        // Si el usuario hace clic en "Aceptar", redirige a la página de inicio de sesión
        if (confirmacion) {
          window.location.href = "Registro-LoginAdministrador/login.html";
        }
        // Si el usuario hace clic en "Cancelar", no hace nada
      }
    </script>
  </body>
</html>
